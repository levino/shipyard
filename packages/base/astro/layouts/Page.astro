---
import 'virtual:shipyard/css'
import { i18n } from 'astro:config/server'
import config from 'virtual:shipyard/config'
import { mapObjIndexed } from 'ramda'
import type {
  NavigationEntry,
  NavigationTree,
  Script,
} from '../../src/schemas/config'
import { cn } from '../../src/tools/cn'
import { getTitle } from '../../src/tools/title'
import {
  AnnouncementBar,
  GlobalDesktopNavigation,
  Npm2YarnScript,
  SidebarNavigation,
} from '../components'
import Footer from './Footer.astro'

type CustomMetaTag = {
  name?: string
  property?: string
  content: string
}

type Props = {
  frontmatter?: {
    title?: string
    description?: string
    keywords?: string[]
    image?: string
    canonicalUrl?: string
    customMetaTags?: CustomMetaTag[]
    sidebarNavigation?: NavigationTree
  }
} & {
  title?: string
  description?: string
  keywords?: string[]
  image?: string
  canonicalUrl?: string
  customMetaTags?: CustomMetaTag[]
  sidebarNavigation?: NavigationTree
}

const currentPath = Astro.url.pathname
const props = Astro.props.frontmatter || Astro.props

const withLocale = (path: string) =>
  i18n ? `/${Astro.currentLocale}${path}` : path
const applyLocaleAndSetActive: (navigation: NavigationTree) => NavigationTree =
  mapObjIndexed((entry: NavigationEntry) => ({
    ...entry,
    ...(entry.href ? { href: withLocale(entry.href) } : {}),
    active: entry.href === currentPath,
    ...(entry.subEntry
      ? { subEntry: applyLocaleAndSetActive(entry.subEntry) }
      : {}),
  }))

const navigation = applyLocaleAndSetActive(config.navigation)
const title = getTitle(config.title, props.title)
const hasSidebar = !!props.sidebarNavigation

// Helper function to render script attributes
const renderScriptAttributes = (script: Script) => {
  if (typeof script === 'string') {
    return { src: script }
  }
  return script
}
---

<html>
  <head>
    <meta charset="utf-8" />
    <title>
      {title}
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={props.description} />
    {props.keywords && props.keywords.length > 0 && (
      <meta name="keywords" content={props.keywords.join(', ')} />
    )}
    <meta property="og:title" content={title} />
    <meta property="og:description" content={props.description} />
    {props.image && (
      <>
        <meta property="og:image" content={props.image} />
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:image" content={props.image} />
      </>
    )}
    {props.canonicalUrl && (
      <link rel="canonical" href={props.canonicalUrl} />
    )}
    {props.customMetaTags?.map((tag) => (
      <meta
        {...(tag.name && { name: tag.name })}
        {...(tag.property && { property: tag.property })}
        content={tag.content}
      />
    ))}

    {config.scripts?.map((script) => {
      const attrs = renderScriptAttributes(script)
      return <script is:inline {...attrs}></script>
    })}
    <slot name="head" />
  </head>
  <body class="flex min-h-screen flex-col">
    {config.announcementBar && <AnnouncementBar config={config.announcementBar} />}
    <div class={cn("drawer grow", { "lg:drawer-open": hasSidebar })}>
      <input id="drawer" type="checkbox" class="drawer-toggle" />
      <div class="drawer-content flex flex-col overflow-x-hidden">
        <GlobalDesktopNavigation
          showBrand={!hasSidebar}
          brand={config.brand}
          navigation={navigation}
        >
          <slot name="navbarExtra" slot="navbarExtra" />
        </GlobalDesktopNavigation>
        <div class="grow">
          <div class="mx-auto max-w-7xl px-4 pb-12">
            <slot />
          </div>
        </div>
      </div>

      <div class="drawer-side z-40">
        <label for="drawer" aria-label="close sidebar" class="drawer-overlay"
        ></label>
        <SidebarNavigation
          brand={config.brand}
          global={navigation}
          local={props.sidebarNavigation}
        >
          <slot name="sidebarExtra" slot="sidebarExtra" />
        </SidebarNavigation>
      </div>
    </div>
    <Footer />
    <Npm2YarnScript />
  </body>
</html>
