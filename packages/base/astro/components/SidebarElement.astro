---
import { cn } from '../../src/tools/cn'
import type { Entry } from './types'

interface Props {
  entry: Entry
  currentPath?: string
}

const { entry, currentPath = Astro.url.pathname } = Astro.props

// Normalize path by removing trailing slash for comparison
const normalizePath = (path: string) => path.replace(/\/$/, '') || '/'

// Check if entry or any of its children are active
const isActiveOrHasActiveChild = (entryValue: Entry[string]): boolean => {
  if (
    entryValue.href &&
    normalizePath(entryValue.href) === normalizePath(currentPath)
  )
    return true
  if (entryValue.subEntry) {
    return Object.values(entryValue.subEntry).some(isActiveOrHasActiveChild)
  }
  return false
}
---

{Object.entries(entry).map(([key, entryValue]) => {
  const label = entryValue.label ?? key;
  const isActive = entryValue.href && normalizePath(entryValue.href) === normalizePath(currentPath);
  const hasActiveChild = entryValue.subEntry && Object.values(entryValue.subEntry).some(isActiveOrHasActiveChild);
  const badge = entryValue.customProps?.badge as string | undefined;
  const badgeType = (entryValue.customProps?.badgeType as string) ?? 'info';
  const badgeClass = {
    'info': 'badge-info',
    'success': 'badge-success',
    'warning': 'badge-warning',
    'error': 'badge-error',
    'primary': 'badge-primary',
    'secondary': 'badge-secondary',
    'accent': 'badge-accent',
  }[badgeType] ?? 'badge-info';
  // For HTML type items with defaultStyle, wrap in a styled container
  const htmlDefaultStyleClass = entryValue.defaultStyle ? 'menu-title' : '';
  return (
    <li class={entryValue.className}>
      {entryValue.href
        ? entryValue.labelHtml
          ? entryValue.defaultStyle
            ? <a href={entryValue.href} class={cn('flex items-center justify-between gap-2', { 'bg-base-200/50 font-medium text-primary': isActive })}><span set:html={entryValue.labelHtml} /></a>
            : <Fragment set:html={entryValue.labelHtml} />
          : <a href={entryValue.href} class={cn('flex items-center justify-between gap-2', { 'bg-base-200/50 font-medium text-primary': isActive })}>
              <span>{label}</span>
              {badge && <span class={cn('badge badge-sm', badgeClass)}>{badge}</span>}
            </a>
        : entryValue.labelHtml
          ? entryValue.defaultStyle
            ? <span class='menu-title'><span set:html={entryValue.labelHtml} /></span>
            : <Fragment set:html={entryValue.labelHtml} />
          : <span class='menu-title flex items-center gap-2'>
              {label}
              {badge && <span class={cn('badge badge-sm', badgeClass)}>{badge}</span>}
            </span>}
      {entryValue.subEntry ? (
        <ul>
          <Astro.self entry={entryValue.subEntry} currentPath={currentPath} />
        </ul>
      ) : null}
    </li>
  )
})}
