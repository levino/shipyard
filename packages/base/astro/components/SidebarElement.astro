---
import { cn } from '../../src/tools/cn'
import type { Entry } from './types'

interface Props {
  entry: Entry
  currentPath?: string
}

const { entry, currentPath = Astro.url.pathname } = Astro.props

// Normalize path by removing trailing slash for comparison
const normalizePath = (path: string) => path.replace(/\/$/, '') || '/'

// Check if entry or any of its children are active
const isActiveOrHasActiveChild = (entryValue: Entry[string]): boolean => {
  if (
    entryValue.href &&
    normalizePath(entryValue.href) === normalizePath(currentPath)
  )
    return true
  if (entryValue.subEntry) {
    return Object.values(entryValue.subEntry).some(isActiveOrHasActiveChild)
  }
  return false
}
---

{Object.entries(entry).map(([key, entryValue]) => {
  const label = entryValue.label ?? key;
  const isActive = entryValue.href && normalizePath(entryValue.href) === normalizePath(currentPath);
  const hasActiveChild = entryValue.subEntry && Object.values(entryValue.subEntry).some(isActiveOrHasActiveChild);
  const hasChildren = entryValue.subEntry && Object.keys(entryValue.subEntry).length > 0;
  const isCollapsible = hasChildren && (entryValue.collapsible !== false);
  // Auto-expand if has active child, otherwise use collapsed setting (default true)
  const shouldBeOpen = hasActiveChild || !(entryValue.collapsed ?? true);

  // Extract badge info from customProps
  const badge = entryValue.customProps?.badge as string | undefined;
  const badgeType = (entryValue.customProps?.badgeType as string) ?? 'info';
  const badgeClass = badge ? `badge badge-${badgeType} badge-sm` : undefined;

  // Helper to render label with optional badge
  const renderLabelWithBadge = (labelContent: any, extraClass?: string) => (
    <span class={cn('flex items-center gap-2', extraClass)}>
      {labelContent}
      {badge && <span class={badgeClass}>{badge}</span>}
    </span>
  );

  return (
    <li class={entryValue.className}>
      {hasChildren && isCollapsible ? (
        // Collapsible category with children
        <details open={shouldBeOpen}>
          <summary>
            {entryValue.href ? (
              entryValue.labelHtml
                ? <Fragment set:html={entryValue.labelHtml} />
                : <a href={entryValue.href} class={cn({ 'bg-base-200/50 font-medium text-primary': isActive })}>{renderLabelWithBadge(label)}</a>
            ) : (
              entryValue.labelHtml
                ? <Fragment set:html={entryValue.labelHtml} />
                : <span class='menu-title'>{renderLabelWithBadge(label)}</span>
            )}
          </summary>
          <ul>
            <Astro.self entry={entryValue.subEntry} currentPath={currentPath} />
          </ul>
        </details>
      ) : hasChildren ? (
        // Non-collapsible category with children (always expanded)
        <>
          {entryValue.href ? (
            entryValue.labelHtml
              ? <Fragment set:html={entryValue.labelHtml} />
              : <a href={entryValue.href} class={cn({ 'bg-base-200/50 font-medium text-primary': isActive })}>{renderLabelWithBadge(label)}</a>
          ) : (
            entryValue.labelHtml
              ? <Fragment set:html={entryValue.labelHtml} />
              : <span class='menu-title'>{renderLabelWithBadge(label)}</span>
          )}
          <ul>
            <Astro.self entry={entryValue.subEntry} currentPath={currentPath} />
          </ul>
        </>
      ) : (
        // Leaf node (no children)
        entryValue.href ? (
          entryValue.labelHtml
            ? <Fragment set:html={entryValue.labelHtml} />
            : <a href={entryValue.href} class={cn({ 'bg-base-200/50 font-medium text-primary': isActive })}>{renderLabelWithBadge(label)}</a>
        ) : (
          entryValue.labelHtml
            ? <Fragment set:html={entryValue.labelHtml} />
            : <span class='menu-title'>{renderLabelWithBadge(label)}</span>
        )
      )}
    </li>
  )
})}
