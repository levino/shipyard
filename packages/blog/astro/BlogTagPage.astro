---
/**
 * Individual tag page - shows all posts with a specific tag.
 */
import { i18n } from 'astro:config/server'
import { type CollectionEntry, getCollection } from 'astro:content'
import blogConfig from 'virtual:shipyard-blog/config'
import tagsMap from 'virtual:shipyard-blog/tags'
import type { GetStaticPaths } from 'astro'
import {
  filter,
  includes,
  map,
  pipe,
  reverse,
  sortBy,
  toLower,
  uniq,
} from 'ramda'
import { getReadingTime, getTagDescription, getTagLabel } from '../src/index'
import BlogReadingTime from './BlogReadingTime.astro'
import BlogTags from './BlogTags.astro'
import Layout from './Layout.astro'

export const getStaticPaths = (async () => {
  const allPosts = await getCollection('blog')
  const { includeDraftsInDev } = blogConfig
  const isDev = import.meta.env.DEV

  // Filter out draft and unlisted posts - defined inside getStaticPaths
  const shouldIncludePost = (post: CollectionEntry<'blog'>) => {
    if (post.data.unlisted) return false
    if (post.data.draft && !(isDev && includeDraftsInDev)) return false
    return true
  }

  // Get all unique tags across all posts
  const getAllTags = pipe(
    filter(shouldIncludePost),
    (posts: CollectionEntry<'blog'>[]) =>
      posts.flatMap((post) => post.data.tags ?? []),
    map(toLower),
    uniq,
  ) as (posts: CollectionEntry<'blog'>[]) => string[]

  const allTags = getAllTags(allPosts)

  if (i18n) {
    // Generate paths for each locale + tag combination
    const paths: Array<{ params: { locale: string; tag: string } }> = []

    for (const locale of i18n.locales) {
      if (typeof locale !== 'string') continue

      // Get tags for this locale's posts
      const localePosts = allPosts.filter((post) => {
        const [postLocale] = post.id.split('/')
        return postLocale === locale
      })
      const localeTags = getAllTags(localePosts)

      for (const tag of localeTags) {
        paths.push({ params: { locale, tag } })
      }
    }

    return paths
  } else {
    return allTags.map((tag) => ({ params: { tag } }))
  }
}) satisfies GetStaticPaths

const { includeDraftsInDev, showReadingTime, routeBasePath } = blogConfig

// Filter out draft and unlisted posts for runtime use
const isDev = import.meta.env.DEV
const shouldIncludePost = (post: CollectionEntry<'blog'>) => {
  if (post.data.unlisted) return false
  if (post.data.draft && !(isDev && includeDraftsInDev)) return false
  return true
}

const { tag } = Astro.params

const allPosts = await getCollection('blog')
const posts = pipe(
  filter(shouldIncludePost),
  filter((post: CollectionEntry<'blog'>) => {
    // Filter by locale if i18n is enabled
    if (i18n) {
      const [postLocale] = post.id.split('/')
      if (postLocale !== Astro.currentLocale) return false
    }
    // Filter by tag (case-insensitive)
    const postTags = post.data.tags ?? []
    return includes(tag.toLowerCase(), map(toLower, postTags))
  }),
  sortBy((post: CollectionEntry<'blog'>) => post.data.date.getTime()),
  reverse,
)(allPosts) as CollectionEntry<'blog'>[]

const formatDate = new Intl.DateTimeFormat(Astro.currentLocale || 'en', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).format

const getBlogPostLink = (id: string, locale?: string) => {
  if (i18n && locale) {
    return id.replace(`${locale}/`, `${locale}/${routeBasePath}/`)
  } else {
    return `${routeBasePath}/${id}`
  }
}

const tagBaseUrl = i18n
  ? `/${Astro.currentLocale}/${routeBasePath}/tags`
  : `/${routeBasePath}/tags`

// Get tag metadata
const tagLabel = getTagLabel(tagsMap, tag)
const tagDescription = getTagDescription(tagsMap, tag)
---

<Layout title={`Posts tagged "${tagLabel}"`}>
  <div class="max-w-4xl mx-auto">
    <div class="mb-8">
      <a
        href={i18n ? `/${Astro.currentLocale}/${routeBasePath}/tags` : `/${routeBasePath}/tags`}
        class="text-sm text-base-content/60 hover:text-primary transition-colors"
      >
        &larr; All tags
      </a>
    </div>

    <h1 class="text-4xl font-bold mb-2">
      Posts tagged "<span class="text-primary">{tagLabel}</span>"
    </h1>
    {tagDescription && (
      <p class="text-lg text-base-content/80 mb-4">{tagDescription}</p>
    )}
    <p class="text-base-content/60 mb-8">
      {posts.length} post{posts.length === 1 ? '' : 's'}
    </p>

    <div class="space-y-8">
      {posts.map((entry) => {
        const readingTime = showReadingTime && entry.body
          ? getReadingTime(entry.body)
          : undefined
        const tags = entry.data.tags ?? []

        return (
          <article class="border-b border-base-300 pb-8 last:border-b-0">
            <a
              class="block no-underline hover:text-primary transition-colors"
              href={`/${getBlogPostLink(entry.id, Astro.currentLocale)}`}
            >
              {entry.data.draft && (
                <span class="badge badge-warning mb-2">Draft</span>
              )}
              <h2 class="text-2xl font-semibold my-0">{entry.data.title}</h2>
            </a>
            <div class="flex flex-wrap items-center gap-2 text-sm text-base-content/60 mt-2">
              <time datetime={entry.data.date.toISOString()}>
                {formatDate(entry.data.date)}
              </time>
              {readingTime && (
                <>
                  <span>Â·</span>
                  <BlogReadingTime text={readingTime.text} />
                </>
              )}
            </div>
            <p class="mt-2 text-base-content/80">{entry.data.description}</p>
            {tags.length > 0 && (
              <div class="mt-3">
                <BlogTags tags={tags} baseUrl={tagBaseUrl} />
              </div>
            )}
          </article>
        )
      })}
    </div>
  </div>
</Layout>
