---
import { i18n } from 'astro:config/server'
import { getCollection, render } from 'astro:content'
import type { NavigationTree } from '@levino/shipyard-base'
import { Breadcrumbs, TableOfContents } from '@levino/shipyard-base/components'
import BaseLayout from '@levino/shipyard-base/layouts/Page.astro'
import { Array as EffectArray, Option } from 'effect'
import { toSidebarEntries } from '../src/sidebarEntries'

interface Props {
  headings?: { depth: number; text: string; slug: string }[]
}

const { headings = [] } = Astro.props

const getPath = (id: string) =>
  i18n ? `/${Astro.currentLocale}/docs/${id.slice(3)}` : `/docs/${id}`

const docs = await getCollection('docs')
  .then(
    EffectArray.map(async (doc) => {
      const {
        id,
        data: {
          title,
          sidebar: { render: shouldBeRendered, label },
          sidebar_position,
          sidebar_label,
          sidebar_class_name,
          sidebar_custom_props,
        },
      } = doc
      return {
        id,
        path: getPath(id),
        title:
          label ??
          title ??
          Option.getOrUndefined(
            EffectArray.findFirst(
              (await render(doc)).headings,
              ({ depth }) => depth === 1,
            ),
          )?.text ??
          id,
        link: shouldBeRendered,
        sidebarPosition: sidebar_position,
        sidebarLabel: sidebar_label,
        sidebarClassName: sidebar_class_name,
        sidebarCustomProps: sidebar_custom_props,
      }
    }),
  )
  .then((promises) => Promise.all(promises))

const fullTree = toSidebarEntries(docs)

const entries: NavigationTree =
  i18n && Astro.currentLocale
    ? (fullTree[Astro.currentLocale]?.subEntry ?? {})
    : fullTree
---

<BaseLayout sidebarNavigation={entries}>
  <div class="prose mx-auto xl:mr-72">
    <Breadcrumbs navigation={entries} />
    <TableOfContents links={headings} />
    <slot />
  </div>
</BaseLayout>
