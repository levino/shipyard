---
import { i18n } from 'astro:config/server'
import { type CollectionKey, getCollection, render } from 'astro:content'
import { docsConfigs } from 'virtual:shipyard-docs-configs'
import type { NavigationTree } from '@levino/shipyard-base'
import { Breadcrumbs, TableOfContents } from '@levino/shipyard-base/components'
import BaseLayout from '@levino/shipyard-base/layouts/Page.astro'
import { experimental_AstroContainer as AstroContainer } from 'astro/container'
import { Array as EffectArray, Option } from 'effect'
import { getPaginationInfo } from '../src/pagination'
import type { DocsData } from '../src/sidebarEntries'
import { toSidebarEntries } from '../src/sidebarEntries'
import DocMetadata from './DocMetadata.astro'
import DocPagination from './DocPagination.astro'
import LlmsTxtSidebarLabel from './LlmsTxtSidebarLabel.astro'

interface Props {
  headings?: { depth: number; text: string; slug: string }[]
  /**
   * The base path for generating doc URLs.
   * @default 'docs'
   */
  routeBasePath?: string
  /**
   * Pre-computed docs data for the sidebar. If provided, this will be used
   * instead of fetching from the default 'docs' collection.
   * Use this when you have multiple docs instances with different collections.
   */
  docsData?: DocsData[]
  /**
   * URL to edit this page in the repository.
   */
  editUrl?: string
  /**
   * The date when this page was last updated.
   */
  lastUpdated?: Date
  /**
   * The name of the author who last updated this page.
   */
  lastAuthor?: string
  /**
   * Whether to hide the table of contents for this page.
   * @default false
   */
  hideTableOfContents?: boolean
  /**
   * Whether to hide the title (H1) heading.
   * @default false
   */
  hideTitle?: boolean
  /**
   * Minimum heading level to include in TOC.
   * @default 2
   */
  tocMinLevel?: number
  /**
   * Maximum heading level to include in TOC.
   * @default 3
   */
  tocMaxLevel?: number
  /**
   * Keywords for SEO.
   */
  keywords?: string[]
  /**
   * Social card/preview image.
   */
  image?: string
  /**
   * Whether to hide the sidebar for this page.
   * When true, the page content spans the full width.
   * @default false
   */
  hideSidebar?: boolean
  /**
   * Custom canonical URL for SEO.
   */
  canonicalUrl?: string
  /**
   * Custom meta tags for the page.
   */
  customMetaTags?: Array<{ name?: string; property?: string; content: string }>
  /**
   * SEO title override for the page's <title> and meta tags.
   * If not provided, uses the default title from heading.
   */
  seoTitle?: string
}

const {
  headings = [],
  routeBasePath = 'docs',
  docsData,
  editUrl,
  lastUpdated,
  lastAuthor,
  hideTableOfContents = false,
  hideSidebar = false,
  hideTitle = false,
  tocMinLevel = 2,
  tocMaxLevel = 3,
  keywords,
  image,
  canonicalUrl,
  customMetaTags,
  seoTitle,
} = Astro.props

// Filter headings based on toc_min/max_heading_level
const filteredHeadings = headings.filter(
  (h) => h.depth >= tocMinLevel && h.depth <= tocMaxLevel,
)

// Normalize the route base path
const normalizedBasePath = routeBasePath.replace(/^\/+|\/+$/g, '')

// Get the collection name from config, defaulting to the route base path
const collectionName =
  docsConfigs[normalizedBasePath]?.collectionName ?? normalizedBasePath

const getPath = (id: string, customSlug?: string) => {
  // Use custom slug if provided
  if (customSlug) {
    if (i18n) {
      return `/${Astro.currentLocale}/${normalizedBasePath}/${customSlug}`
    }
    return `/${normalizedBasePath}/${customSlug}`
  }

  // Remove the .md extension if present and handle index pages
  const cleanId = id.replace(/\.md$/, '')
  const isIndex = cleanId.endsWith('/index') || cleanId === 'index'

  if (i18n) {
    // For i18n, slice off the locale prefix (e.g., 'en/')
    const pathPart = cleanId.slice(3)
    const finalPath = isIndex ? pathPart.replace(/\/?index$/, '') : pathPart
    return `/${Astro.currentLocale}/${normalizedBasePath}/${finalPath}`
  }

  const finalPath = isIndex ? cleanId.replace(/\/?index$/, '') : cleanId
  return `/${normalizedBasePath}/${finalPath}`
}

// Use provided docsData or fetch from the configured collection
const docs =
  docsData ??
  (await getCollection(collectionName as CollectionKey)
    .then(
      EffectArray.map(async (doc) => {
        const {
          id: fileId,
          data: {
            id: customId,
            title,
            sidebar: { render: shouldBeRendered, label },
            sidebar_position,
            sidebar_label,
            sidebar_class_name,
            sidebar_custom_props,
            slug: customSlug,
            pagination_next,
            pagination_prev,
            pagination_label,
          },
        } = doc
        return {
          // Use custom id from frontmatter if provided, otherwise use file path-based id
          id: customId ?? fileId,
          fileId,
          path: getPath(fileId, customSlug),
          slug: customSlug,
          title:
            label ??
            title ??
            Option.getOrUndefined(
              EffectArray.findFirst(
                (await render(doc)).headings,
                ({ depth }) => depth === 1,
              ),
            )?.text ??
            fileId,
          link: shouldBeRendered,
          sidebarPosition: sidebar_position,
          sidebarLabel: sidebar_label,
          sidebarClassName: sidebar_class_name,
          sidebarCustomProps: sidebar_custom_props,
          pagination_next,
          pagination_prev,
          pagination_label,
        }
      }),
    )
    .then((promises) => Promise.all(promises)))

const fullTree = toSidebarEntries(docs)

const entries: NavigationTree =
  i18n && Astro.currentLocale
    ? (fullTree[Astro.currentLocale]?.subEntry ?? {})
    : fullTree

// Compute pagination info for the current page BEFORE adding llms.txt
// (llms.txt should not be part of pagination navigation)
const pagination = getPaginationInfo(Astro.url.pathname, entries, docs)

// Add llms.txt link to sidebar if enabled for this docs instance
// This is added AFTER pagination computation so it doesn't affect prev/next navigation
const docsConfig = docsConfigs[normalizedBasePath]
const llmsTxtHref = `/${normalizedBasePath}/llms.txt`
// Render the LlmsTxtSidebarLabel component to HTML using Astro Container
if (docsConfig?.llmsTxtEnabled) {
  const container = await AstroContainer.create()
  const llmsTxtLabelHtml = await container.renderToString(LlmsTxtSidebarLabel, {
    props: { href: llmsTxtHref },
  })
  entries['llms.txt'] = {
    labelHtml: llmsTxtLabelHtml,
  }
}
---

<BaseLayout title={seoTitle} sidebarNavigation={hideSidebar ? undefined : entries} keywords={keywords} image={image} canonicalUrl={canonicalUrl} customMetaTags={customMetaTags}>
  <div class={`grid grid-cols-12 gap-6 max-w-7xl mx-auto`}>
    <div class={hideTableOfContents ? 'col-span-12' : 'col-span-12 xl:col-span-9'}>
      <div class:list={['prose max-w-none', { 'hide-title': hideTitle }]}>
        <Breadcrumbs navigation={entries} />
        {!hideTableOfContents && <TableOfContents links={filteredHeadings} class="xl:hidden" />}
        <slot />
        <DocMetadata editUrl={editUrl} lastUpdated={lastUpdated} lastAuthor={lastAuthor} />
        <DocPagination prev={pagination.prev} next={pagination.next} />
      </div>
    </div>
    {!hideTableOfContents && (
      <div class="hidden xl:block col-span-3">
        <div class="sticky top-20 max-h-[calc(100vh-6rem)] overflow-y-auto">
          <TableOfContents links={filteredHeadings} desktopOnly />
        </div>
      </div>
    )}
  </div>
</BaseLayout>

<style>
  .hide-title :global(h1:first-of-type) {
    display: none;
  }
</style>
