---
import { getCollection, render } from 'astro:content'
import {
  type DocsData,
  getDocPath,
  getRouteParams,
} from '@levino/shipyard-docs'
import { DocsLayout } from '@levino/shipyard-docs/astro'

export async function getStaticPaths() {
  const docs = await getCollection('guides')
  return docs.map((entry) => ({
    params: getRouteParams(entry.id, true),
    props: { entry },
  }))
}

const { entry } = Astro.props
const { Content, headings } = await render(entry)

// Get current locale from route params
const currentLocale = Astro.params.locale ?? 'en'

// Build sidebar data for guides - filter by current locale
const allGuides = await getCollection('guides')
const localeGuides = allGuides.filter((doc) =>
  doc.id.startsWith(`${currentLocale}/`),
)
const docsData: DocsData[] = localeGuides.map((doc) => ({
  id: doc.id,
  path: getDocPath(doc.id, 'guides', true, currentLocale),
  title: doc.data.title ?? doc.id,
  link: doc.data.sidebar?.render !== false,
  sidebarPosition: doc.data.sidebar_position,
  sidebarLabel: doc.data.sidebar_label,
  sidebarClassName: doc.data.sidebar_class_name,
}))
---

<DocsLayout headings={headings} routeBasePath="guides" docsData={docsData}>
  <Content />
</DocsLayout>
